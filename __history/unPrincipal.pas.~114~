unit unPrincipal;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls, Vcl.ComCtrls,
  Data.DB, Data.Win.ADODB, unBuscar;

type
  TForm1 = class(TForm)
    Pn1: TPanel;
    btnGravar: TButton;
    btnNovo: TButton;
    btnEditar: TButton;
    btnSair: TButton;
    pgCadastro: TPageControl;
    btnBuscar: TButton;
    btnCancelar: TButton;
    tsCadastro: TTabSheet;
    tsContador: TTabSheet;
    tsFiscal: TTabSheet;
    pnEmpresa: TPanel;
    lbCodigo: TLabel;
    edtCodigo: TEdit;
    lbRazaoSocial: TLabel;
    edtRazaoSocial: TEdit;
    lbFantasia: TLabel;
    edtFantasia: TEdit;
    edtCnpj: TEdit;
    lbCnpj: TLabel;
    edtIe: TEdit;
    lbInscricao: TLabel;
    lbEmail: TLabel;
    edtEmail: TEdit;
    edtTelefone: TEdit;
    lbTelefone: TLabel;
    edtCodCli: TEdit;
    lbCodCli: TLabel;
    edtCodFornec: TEdit;
    lbCodFornec: TLabel;
    edtNomeCli: TEdit;
    edtNomeFornec: TEdit;
    pn2: TPanel;
    lbEnderecoEmpresa: TLabel;
    edtEndereco: TEdit;
    lbEndereco: TLabel;
    lbBairro: TLabel;
    edtBairro: TEdit;
    lbCep: TLabel;
    edtCep: TEdit;
    edtComplemento: TEdit;
    lbComplemento: TLabel;
    edtCidade: TEdit;
    edtCodmunicipio: TEdit;
    lbCidade: TLabel;
    lbCodMunicipio: TLabel;
    lbCodMunicipi: TLabel;
    cbUf: TComboBox;
    lbNomeContador: TLabel;
    edtNomeContador: TEdit;
    lbCpfCnpjContador: TLabel;
    edtCpfCnpjContador: TEdit;
    lbCrcContador: TLabel;
    edtCrcContador: TEdit;
    pn3: TPanel;
    lbEnderecoContador: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    edtEnderecoContador: TEdit;
    edtBairroContador: TEdit;
    edtCepContador: TEdit;
    edtComplementoContador: TEdit;
    edtCidadeContador: TEdit;
    edtCodMunicipioContador: TEdit;
    cbUfContador: TComboBox;
    lbEmailContador: TLabel;
    edtEmailContador: TEdit;
    edtTelefoneContador: TEdit;
    lbTelefoneContador: TLabel;
    edtProxNumNfe: TEdit;
    lbProxNumNota: TLabel;
    edtSerie: TEdit;
    edtPerProtege: TEdit;
    lbPerProtege: TLabel;
    lbSerie: TLabel;
    pn4: TPanel;
    lbDirTelas: TLabel;
    edtDirTelas: TEdit;
    lbTipoTribut: TLabel;
    cbTipoTribut: TComboBox;
    lbProxNumNfce: TLabel;
    edtProxNumNfce: TEdit;
    lbProxNumCte: TLabel;
    edtProxNumCte: TEdit;
    edtProxNumMdfe: TEdit;
    lbProxNumMdfe: TLabel;
    lbDirNfe: TLabel;
    edtDirNfe: TEdit;
    edtDirMdfe: TEdit;
    lbDirMdfe: TLabel;
    lbEnviaApp: TLabel;
    cbEnviarApp: TComboBox;
    cbTransportadora: TComboBox;
    lbTrasnportador: TLabel;
    lbUsaCredIcms: TLabel;
    cbUsaCredPisCofins: TComboBox;
    lbUsaCredPisCofins: TLabel;
    cbUsaCredIcms: TComboBox;
    lbProxCodCli: TLabel;
    edtProxCodCli: TEdit;
    edtProxCodFornec: TEdit;
    lbProxCodFornec: TLabel;
    edtProxCodProd: TEdit;
    lbProxCodProd: TLabel;
    ADOConnection1: TADOConnection;
    ADOQuery1: TADOQuery;
    cbBloqNfNContribEstadual: TComboBox;
    cbBloqNfNContribInter: TComboBox;
    lbBloqNfNContribInter: TLabel;
    lbBloqNfNContribEstadual: TLabel;
    cbBloqNfPfEstadual: TComboBox;
    lbBloqNfPfEstadual: TLabel;
    lbBloqNfPfInter: TLabel;
    cbBloqNfPfInter: TComboBox;
    procedure btnSairClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure btnNovoClick(Sender: TObject);
    procedure btnCancelarClick(Sender: TObject);
    procedure btnGravarClick(Sender: TObject);
    procedure LimparCampos;
    function ProxCodEmpresa: Integer;
    function MontaCamposValores: TStringList;
    procedure edtCodCliChange(Sender: TObject);
    procedure edtCodFornecChange(Sender: TObject);
    procedure btnBuscarClick(Sender: TObject);
    procedure CarregarEmpresa(Codigo: Integer);
    procedure btnEditarClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form1: TForm1;
  quemChamou: String;

implementation

{$R *.dfm}


procedure TForm1.btnBuscarClick(Sender: TObject);
var
  Codigo: Integer;
begin
  with TForm2.Create(Self) do
  try
    Codigo := SelecionarEmpresa;
  finally
    Free;
  end;

  if Codigo > 0 then
    begin
    CarregarEmpresa(Codigo);
    btnEditar.Enabled:= True;
    end;




end;

procedure TForm1.CarregarEmpresa(Codigo: Integer);
var
  qry: TADOQuery;
begin
  qry := TADOQuery.Create(nil);
  try
    qry.Connection := ADOConnection1;
    qry.SQL.Text :=
      'SELECT * FROM AC_CADASTRO_EMPRESA WHERE CODFILIAL = :CODFILIAL';
    qry.Parameters.ParamByName('CODFILIAL').Value := Format('%.2d', [Codigo]); // <=== use o parâmetro
    qry.Open;

    if qry.IsEmpty then
    begin
      ShowMessage('Empresa não encontrada!');
      Exit;
    end;

    // preencha os controles
    edtCodigo.Text       := qry.FieldByName('CODFILIAL').AsString;

    edtRazaoSocial.Text  := qry.FieldByName('FILIAL').AsString;   // ou 'RAZAO_SOCIAL'
    edtCnpj.Text         := qry.FieldByName('CPFCNPJ').AsString;
    edtEndereco.Text     := qry.FieldByName('ENDERECO').AsString;
    // ... continue mapeando conforme seus campos
  finally
    qry.Free;
  end;
end;




procedure TForm1.btnCancelarClick(Sender: TObject);
var
I: integer;

begin

 btnBuscar.Enabled:= True;
 btnNovo.Enabled:= True;
 btnSair.Enabled:= True;
 btnCancelar.Enabled:= False;
 btnGravar.Enabled:= False;

 tsCadastro.Enabled:= False;
 tsContador.Enabled:= False;
 tsFiscal.Enabled:= False;

 LimparCampos;

end;

procedure TForm1.btnEditarClick(Sender: TObject);
begin
 tsCadastro.Enabled:= True;
 tsContador.Enabled:= True;
 tsFiscal.Enabled:= True;

 btnBuscar.Enabled:= False;
 btnCancelar.Enabled:= True;
 btnGravar.Enabled:= True;
 btnNovo.Enabled:= False;

 quemChamou:= 'Editar';
end;

procedure TForm1.btnGravarClick(Sender: TObject);
var
  Lista: TStringList;
begin

  if quemChamou = 'Editar' then
  begin
    showMessage('Fazer Comando de Update');
    Lista:= MontaCamposValores;
  end;

  if quemChamou = 'Novo' then
  begin
    showMessage('Fazer Comando de Insert');
    Lista:= MontaCamposValores;
  end;


  showMessage(Lista.Text);
end;


procedure TForm1.btnNovoClick(Sender: TObject);

var
proxCod: Integer;

begin

 btnBuscar.Enabled:= False;
 btnNovo.Enabled:= False;
 btnSair.Enabled:= False;
 btnCancelar.Enabled:= True;
 btnGravar.Enabled:= True;

 tsCadastro.Enabled:= True;
 tsContador.Enabled:= True;
 tsFiscal.Enabled:= True;

 edtCodigo.Text:= InttoStr(ProxCodEmpresa);

 quemChamou:= 'Novo';

 cbUsaCredIcms.ItemIndex := 0;
 cbEnviarApp.ItemIndex := 0;
 cbTransportadora.ItemIndex := 1;
 cbBloqNfNContribEstadual.ItemIndex := 1;
 cbBloqNfNContribInter.ItemIndex := 1;
 cbBloqNfPfEstadual.ItemIndex := 1;
 cbBloqNfPfInter.ItemIndex := 1;
 cbUsaCredPisCofins.ItemIndex := 0;


end;

procedure TForm1.btnSairClick(Sender: TObject);
begin
  Close;
end;

procedure TForm1.FormCreate(Sender: TObject);
begin
  cbUf.Items.Clear;
  cbUf.Items.AddStrings(['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA',
                              'MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN',
                              'RS','RO','RR','SC','SP','SE','TO']);

  cbUfContador.Items.Clear;
  cbUfContador.Items.AddStrings(['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA',
                              'MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN',
                              'RS','RO','RR','SC','SP','SE','TO']);

  cbTipoTribut.Items.Clear;
  cbtipotribut.Items.AddStrings(['1 - Simples Nacional','2 - Lucro Presumido', '3 - Lucro Real' ]);

  cbEnviarApp.Items.Clear;
  cbEnviarApp.Items.AddStrings(['Sim','Não']);

  cbTransportadora.Items.Clear;
  cbTransportadora.Items.AddStrings(['Sim','Não']);

  cbBloqNfNContribEstadual.Items.Clear;
  cbBloqNfNContribEstadual.Items.AddStrings(['Sim','Não']);

  cbBloqNfNContribInter.Items.Clear;
  cbBloqNfNContribInter.Items.AddStrings(['Sim','Não']);

  cbBloqNfPfEstadual.Items.Clear;
  cbBloqNfPfEstadual.Items.AddStrings(['Sim','Não']);

  cbBloqNfPfInter.Items.Clear;
  cbBloqNfPfInter.Items.AddStrings(['Sim','Não']);

  cbUsaCredPisCofins.Items.Clear;
  cbUsaCredPisCofins.Items.AddStrings(['Sim','Não']);

  cbUsaCredIcms.Items.Clear;
  cbUsaCredIcms.Items.AddStrings(['Sim','Não']);

end;

procedure TForm1.LimparCampos;
var
  i: Integer;
begin
  for i := 0 to ComponentCount - 1 do
  begin
    if Components[i] is TEdit then
      (Components[i] as TEdit).Clear
    else if Components[i] is TComboBox then
      (Components[i] as TComboBox).ItemIndex := -1;
  end;
end;

function TForm1.ProxCodEmpresa: Integer;
var

proxCodEmpresa: Integer;

begin
    ADOQuery1.Close;
    ADOQuery1.SQL.Clear;
    ADOQuery1.SQL.Add('SELECT MAX(CODFILIAL) AS CODFILIAL FROM AC_CADASTRO_EMPRESA');
    ADOQuery1.Open;

    if ADOQuery1.Fields[0].IsNull then
    begin
      proxCodEmpresa:= 1;

    end
    else
    begin
     proxCodEmpresa:= ADOQuery1.FieldByName('CODFILIAL').AsInteger + 1;
    end;


    result:= proxCodEmpresa;

end;

// Função que cria dinamicamente uma lista de "Campo=Valor"
// Isso centraliza a lógica de quais campos serão gravados
function TForm1.MontaCamposValores: TStringList;
begin
  Result := TStringList.Create;

  // -------- Identificação / cadastro --------
  if Trim(edtCodigo.Text) <> ''        then Result.Add('CODFILIAL='      + Trim(edtCodigo.Text));
  if Trim(edtRazaoSocial.Text) <> ''   then Result.Add('FILIAL='         + Trim(edtRazaoSocial.Text)); // Razão social
  if Trim(edtFantasia.Text) <> ''      then Result.Add('NOMEFANTASIA='   + Trim(edtFantasia.Text));
  if Trim(edtCnpj.Text) <> ''          then Result.Add('CPFCNPJ='        + Trim(edtCnpj.Text));
  if Trim(edtIe.Text) <> ''            then Result.Add('IE='             + Trim(edtIe.Text));
  if Trim(edtEmail.Text) <> ''         then Result.Add('EMAIL='          + Trim(edtEmail.Text));
  if Trim(edtCodCli.Text) <> ''        then Result.Add('CODCLI='         + Trim(edtCodCli.Text));
  if Trim(edtCodFornec.Text) <> ''     then Result.Add('CODFORNEC='      + Trim(edtCodFornec.Text));
  if Trim(edtTelefone.Text) <> ''      then Result.Add('TELEFONE='       + Trim(edtTelefone.Text));

  // -------- Endereço da empresa --------
  if Trim(edtEndereco.Text) <> ''      then Result.Add('ENDERECO='       + Trim(edtEndereco.Text));
  if Trim(edtBairro.Text) <> ''        then Result.Add('BAIRRO='         + Trim(edtBairro.Text));
  if Trim(edtCidade.Text) <> ''        then Result.Add('CIDADE='         + Trim(edtCidade.Text));
  if Trim(edtCep.Text) <> ''           then Result.Add('CEP='            + Trim(edtCep.Text));
  if Trim(edtComplemento.Text) <> ''   then Result.Add('COMPLEMENTO='    + Trim(edtComplemento.Text));
  if Trim(edtCodMunicipio.Text) <> ''  then Result.Add('CODMUNICIPIO='   + Trim(edtCodMunicipio.Text));

  // A tabela tem UF e ESTADO. Se você quiser espelhar o mesmo valor nos dois:
  if Trim(cbUf.Text) <> '' then
  begin
    Result.Add('UF='     + Trim(cbUf.Text));
    Result.Add('ESTADO=' + Trim(cbUf.Text)); // remova esta linha se ESTADO não for usado
  end;

  // -------- Numeração / configurações fiscais --------
  if Trim(edtProxNumNfe.Text) <> ''    then Result.Add('PROXNUMNOTA='           + Trim(edtProxNumNfe.Text));
  if Trim(edtSerie.Text) <> ''         then Result.Add('SERIE='                 + Trim(edtSerie.Text));
  if Trim(cbTipoTribut.Text) <> ''     then Result.Add('TIPOTRIBUT='            + Trim(cbTipoTribut.Text));
  if Trim(edtProxNumNfce.Text) <> ''   then Result.Add('PROXNUMNFCONSUMIDOR='   + Trim(edtProxNumNfce.Text));
  if Trim(edtDirNfe.Text) <> ''        then Result.Add('DIRNFE='                + Trim(edtDirNfe.Text));
  if Trim(edtProxNumCte.Text) <> ''    then Result.Add('PROXNUMCONHEC='         + Trim(edtProxNumCte.Text));
  if Trim(edtProxNumMdfe.Text) <> ''   then Result.Add('PROXNUMMDFE='           + Trim(edtProxNumMdfe.Text));
  if Trim(edtDirMdfe.Text) <> ''       then Result.Add('DIRMDFE='               + Trim(edtDirMdfe.Text));
  if Trim(cbTransportadora.Text) <> '' then Result.Add('TRANSPORTADORA='        + Trim(cbTransportadora.Text));

  // -------- Dados do contador --------
  if Trim(edtNomeContador.Text) <> ''        then Result.Add('CONTADORNOME='        + Trim(edtNomeContador.Text));
  if Trim(edtCpfCnpjContador.Text) <> ''     then Result.Add('CONTADORCPFCNPJ='     + Trim(edtCpfCnpjContador.Text));
  if Trim(edtCrcContador.Text) <> ''         then Result.Add('CONTADORCRC='         + Trim(edtCrcContador.Text));
  if Trim(cbUfContador.Text) <> ''           then Result.Add('CONTADORUF='          + Trim(cbUfContador.Text));
  if Trim(edtCepContador.Text) <> ''         then Result.Add('CONTADORCEP='         + Trim(edtCepContador.Text));
  if Trim(edtEnderecoContador.Text) <> ''    then Result.Add('CONTADORENDERECO='    + Trim(edtEnderecoContador.Text));
  if Trim(edtComplementoContador.Text) <> '' then Result.Add('CONTADORCOMPLEMENTO=' + Trim(edtComplementoContador.Text));
  if Trim(edtBairroContador.Text) <> ''      then Result.Add('CONTADORBAIRRO='      + Trim(edtBairroContador.Text));
  if Trim(edtTelefoneContador.Text) <> ''    then Result.Add('CONTADORTELEFONE='    + Trim(edtTelefoneContador.Text));
  if Trim(edtEmailContador.Text) <> ''       then Result.Add('CONTADOREMAIL='       + Trim(edtEmailContador.Text));
end;


procedure TForm1.edtCodCliChange(Sender: TObject);
begin
  if edtCodigo.Text <> '' then
  begin
    try
      ADOQuery1.Close;
      ADOQuery1.SQL.Clear;
      ADOQuery1.SQL.Add('SELECT CLIENTE FROM AC_CADASTRO_CLIENTES WHERE CODCLI = :codigobuscar');
      ADOQuery1.Parameters.ParamByName('codigobuscar').Value := edtCodCli.Text;
      ADOQuery1.Open;

      if not ADOQuery1.Fields[0].IsNull then
        edtNomeCli.Text := ADOQuery1.Fields[0].AsString
      else
        edtNomeCli.Clear;

    finally
      ADOQuery1.Close;
    end;
  end
  else
    edtNomeCli.Clear; // se apagar o código, limpa também o nome
end;

procedure TForm1.edtCodFornecChange(Sender: TObject);
begin
  if edtCodFornec.Text <> '' then
  begin
    try
      ADOQuery1.Close;
      ADOQuery1.SQL.Clear;
      ADOQuery1.SQL.Add('SELECT FORNECEDOR FROM AC_CADASTRO_FORNECEDORES WHERE CODFORNEC = :codigobuscar');
      ADOQuery1.Parameters.ParamByName('codigobuscar').Value := edtCodFORNEC.Text;
      ADOQuery1.Open;

      if not ADOQuery1.Fields[0].IsNull then
        edtNomeFornec.Text := ADOQuery1.Fields[0].AsString
      else
        edtNomeFornec.Clear;

    finally
      ADOQuery1.Close;
    end;
  end
  else
    edtNomeFornec.Clear; // se apagar o código, limpa também o nome
end;

end.
